<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
        
            * {
                box-sizing: border-box;
                font-family: sans-serif;
            }

            /* Create three columns that floats next to each other */
            .columnAnimal {
                float: left;
                width: 10%;
                height: 500px;
                padding: 10px;
                padding-left: 0px;
                transform: translate(0%,-7%);
                
            }

            .columnParts {
                float: left;
                width: 35%;
                height: 500px;
                padding: 10px;
                padding-left: 20px;
            }

            .columnMap {
                float: left;
                width: 55%;
                height: 500px;
                padding: 10px;
            }

            .columnFooter {
                float: left;
                width: 33.33%;
                padding: 10px;
                padding-left: 0px;
            }

            /* Clear floats after the columns */
            .row:after {
                content: "";
                display: table;
                clear: both;
            }

            /*Defining buttons with images*/
            .button {
                background-color: white; /* This is whitesmoke so as to mask the artefacts around the buttons */
                border: none;
                color: white;
                padding: 0px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 16px;
                margin: 4px 2px;
                cursor: pointer;
                border-radius: 50%;
                align-content: center;
                padding-bottom: 10px;
                padding-left: 10%;
            }

            /*Defining the Map SVG*/
            .Map-Container{
                width: 100%;
                height: 540px;
            }
            
            .map{
                transform: translate(-18%,-2%);
            }

            img {
                
                text-align: center;
            }
            
            .rounded{
                border-radius: 50%;
            }

            button:focus,img:focus{
                outline: none;
                border:none;
            }

            /*Main titles*/
            h1 {
                text-align: center;
            }

            h2 {
                padding-bottom: 10px;
                text-align: center;
            }

            /*Default background*/
            body {
                background-color: white;
            }

            /*Adding overlay effects for the buttons*/
            .image-container {
                position: relative;
            }

            .image-container .after {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 99%;
                display: none;
                color: #FFF;
                border-style: solid;
            }

            .image-container:hover .after {
                display: block;
                background: rgba(0, 0, 0, .6);
                border-radius: 50%;
                border-style: solid;
                border-color: #D81E05;
            }
            
            .names {
                fill: none;
                stroke: #fff;
                stroke-linejoin: round;    
            }
            
            /* Tooltip CSS */
            .d3-tip {
                line-height: 1.5;
                font-weight: 400;
                font-family:"avenir next", Arial, sans-serif;
                padding: 6px;
                background: rgba(255, 255, 255, 1);
                color: #D81E05;
                border-radius: 1px;
                pointer-events: none;
                border: 1px solid red;
                
            }

            /* Creates a small triangle extender for the tooltip */
            .d3-tip:after {
                box-sizing: border-box;
                display: inline;
                font-size: 8px;
                width: 100%;
                line-height: 1.5;
                color: #D81E05;
                position: absolute;
                pointer-events: none;
            }

            /* Northward tooltips */
            .d3-tip.n:after {
                content: "\25BC";
                margin: -1px 0 0 0;
                top: 100%;
                left: 0;
                text-align: center;
            }

            /* Eastward tooltips */
            .d3-tip.e:after {
                content: "\25C0";
                margin: -4px 0 0 0;
                top: 50%;
                left: -9px;
            }

            /* Southward tooltips */
            .d3-tip.s:after {
                content: "\25B2";
                margin: 0 0 1px 0;
                top: -8px;
                left: 0;
                text-align: center;
            }

            /* Westward tooltips */
            .d3-tip.w:after {
                content: "\25B6";
                margin: -4px 0 0 -1px;
                top: 50%;
                left: 102%;
            }
            
            .details{
                color:#D81E05;
            }
            
            /* For annotations and other elements - Annotations for human parts */
            .annotation path {
              stroke: #D81E05;
              fill: none;
            }

            .annotation path.connector-arrow, 
            .annotation.callout.circle .annotation-subject path{
                 
                fill: #D81E05;
                  
            }
            
            .title text, .annotation text{
              font-size: 10px;  
            }

            .annotation-note-bg {
              fill: rgba(255, 255, 255, 0);
            }

            .annotation-note-title {
              font-weight: bold;
            }

            .hidden {
              display: none;
            }
            
            .imghidden {
                opacity: 0;    
            }

            text.hover {
              font-size: .7em;
            }

            text.title {
              font-size: 1.1em;
            }
            
            .subject{
                
                cursor: pointer;
                fill-opacity: 1;
                
            }
                   
        </style>

    </head>

    <body>

        <h1>The Illegal Wildlife Trade</h1>

        <div class = "row">
        
            <div class = "columnAnimal">

                <h2></h2>
                <button class = "button BTiger">

                    <div class="image-container">
                        <img class="rounded" src="images/tigericon.png"/>
                        <div class="after"><p style="transform: translate(0,100%)">Tiger</p></div>
                    </div>

                </button>

                <button class = "button BElephant">

                    <div class ="image-container">
                        <img class="rounded" src="images/elephanticon.png"/>
                        <div class="after"><p style="transform: translate(0,100%)">Elephant</p></div>
                    </div>

                </button>

                <button class = "button BRhino">

                    <div class ="image-container">
                        <img class="rounded" src="images/rhinoicon.png"/>
                        <div class="after"><p style="transform: translate(0,100%)">Rhino</p></div>
                    </div>

                </button>

                <button class = "button BParrot">

                    <div class="image-container">
                        <img class="rounded" src="images/greyparroticon.png"/>
                        <div class="after"><p style="transform: translate(0,100%)">Grey Parrot</p></div>
                    </div>

                </button>

            </div>
            <div class="columnParts">

                <h2></h2>
                <img class = "Tiger" style ="position: relative; transform: translate(10%,20%)" src="images/tiger.png"/>
                <img class = "Elephant imghidden" style ="position: relative; transform: translate(10%,-70%)" src="images/elephant.png"/>
                <img class = "Rhino imghidden" style ="position: relative; transform: translate(10%, -190%)" src="images/rhino.png"/>
                <img class = "Parrot imghidden" style ="position: relative; transform: translate(30%, -350%)" src="images/greyparrot.png"/>
                
                <svg style="width: 450px; height: 540; transform: translate(10%,-260%)"></svg>
                
                
            </div>
            
            <div class="columnMap">

                <h2></h2>
                <svg class = "Map-Container"></svg>

            </div>

        </div>   
        
        <div class="footer">
        <div class = "row">
        
            <div class = "columnFooter"></div>
            <div class = "columnFooter"></div>
            <div class = "columnFooter"></div>        
            
            <p><b>Created by: </b>Karthik Balakrishna, Ishaan Paranjape, Pranav Venkata</p>
            <p><b>In Collaboration with </b>Professor. Suresh Lodha</p>
            <p><b>For:</b> CMPS 263, Winter 18</p>
        
        </div>
    </div>

        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="https://d3js.org/queue.v1.min.js"></script>
        <script src="https://d3js.org/topojson.v1.min.js"></script>
        <script src="https://d3js.org/d3-geo.v1.min.js"></script>
        <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>

        <script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
        <script src="d3-tip.js"></script>
        <script>
            
           /* d3.json("world_countries.json", function(topology){
                
                d3.csv("codes.csv", function (codes){
                    
                    for (i =0; i<topology.features.length; i++){
                        
                        var countryID = topology.features[i].id;  
                        for (j = 0; j<codes.length; j++){
                            
                            if (codes[j].alpha3 == countryID){
                                var code = codes[j].alpha2;
                                topology.features[i].id = code;
                            }
                        }
                    }
                    
                    //topology.features[176].id = "1";
                    //console.log(topology.features);    
                    console.log(JSON.stringify(topology));
                
                });            
            });*/
            
            /*d3.select(".Rhino").classed("imghidden",true);
            d3.select(".Elephant").classed("imghidden",true);
            d3.select(".Parrot").classed("imghidden",true);
            */
            
            // Setting annotations for body parts
            
            const annotations = [       
            {
              type: d3.annotationCalloutCircle,
              note: {
                label: "Your Bones would be used in Traditional Medicine in countries like China and India.",
                title: "BONES",
                wrap: 100
              },
              //settings for the subject, in this case the circle radius
              subject: {
                radius: 5
              },
              x: 250,
              y: 305,
              dy: 30,
              dx: 40
            },
            {
              type: d3.annotationCalloutCircle,
              note: {
                label: "Description for feet.",
                title: "FEET",
                wrap: 100
              },
              //settings for the subject, in this case the circle radius
              subject: {
                radius: 5
              },
              x: 252,
              y: 375,
              dy: -20,
              dx: 50
            },
            {
              type: d3.annotationCalloutCircle,
              note: {
                label: "Description for Gall Bladder.",
                title: "GALL BLADDER",
                wrap: 100
              },
              //settings for the subject, in this case the circle radius
              subject: {
                radius: 3
              },
              x: 233,
              y: 222,
              dy: 40,
              dx: 40
            },
            {
              type: d3.annotationCalloutCircle,
              note: {
                label: "Description for Heart.",
                title: "HEART",
                wrap: 100
              },
              //settings for the subject, in this case the circle radius
              subject: {
                radius: 3
              },
              x: 233,
              y: 195,
              dy: -40,
              dx: 40
            },
            {
              type: d3.annotationCalloutCircle,
              note: {
                label: "Description for Teeth.",
                title: "TEETH",
                wrap: 100
              },
              //settings for the subject, in this case the circle radius
              subject: {
                radius: 3
              },
              x: 237,
              y: 135,
              dy: 15,
              dx: 60
            },    
            {
              type: d3.annotationCalloutCircle,
              note: {
                label: "Description for Hair.",
                title: "HAIR",
                wrap: 100
              },
              //settings for the subject, in this case the circle radius
              subject: {
                radius: 3
              },
              x: 233,
              y: 75,
              dy: -10,
              dx: 50
            },    
            {
              type: d3.annotationCalloutCircle,
              note: {
                label: "Description for Liver.",
                title: "LIVER",
                wrap: 100
              },
              //settings for the subject, in this case the circle radius
              subject: {
                radius: 3
              },
              x: 213,
              y: 222,
              dy: 30,
              dx: -30
            },
            {
              type: d3.annotationCalloutCircle,
              note: {
                label: "Description for Nails. Description for Nails.",
                title: "NAILS",
                wrap: 100
              },
              //settings for the subject, in this case the circle radius
              subject: {
                radius: 3
              },
              x: 105,
              y: 223,
              dy: 30,
              dx: -5
            },    
            {
              type: d3.annotationCalloutCircle,
              note: {
                label: "Description for Skin.",
                title: "SKIN",
                wrap: 100
              },
              //settings for the subject, in this case the circle radius
              subject: {
                radius: 5
              },
              x: 195,
              y: 162,
              dy: -30,
              dx: -30
            },
            {
              type: d3.annotationCalloutCircle,
              note: {
                label: "Description for Blood.",
                title: "BLOOD",
                wrap: 100
              },
              //settings for the subject, in this case the circle radius
              subject: {
                radius: 5
              },
              x: 200,
              y: 359,
              dy: -30,
              dx: -30
            },    
            {
              type: d3.annotationCalloutCircle,
              note: {
                label: "Description for Ears.",
                title: "EARS",
                wrap: 100
              },
              //settings for the subject, in this case the circle radius
              subject: {
                radius: 3
              },
              x: 190,
              y: 110,
              dy: -30,
              dx: -30
            },    
            ].map(function(d){ d.color = "#D81E05"; return d});

            const makeAnnotations = d3.annotation()
              .type(d3.annotationLabel)
              .annotations(annotations)
            .on('subjectover', function (annotation) {
                annotation.type.a.selectAll("g.annotation-connector, g.annotation-note").classed("hidden", false);
            })
            .on('subjectout', function (annotation) {
                annotation.type.a.selectAll("g.annotation-connector, g.annotation-note").classed("hidden", true);
            });

            d3.select("svg")
              .append("g")
              .attr("class", "annotation-group")
              .call(makeAnnotations);
            
            d3.select(".annotation-group").selectAll("g.annotation-connector, g.annotation-note").classed("hidden", true);     
            
            
            //Setting up buttons 
            d3.select(".BTiger").on("click", function(){
                console.log("Tiger");
                
                d3.select(".Tiger").classed("imghidden",false);
                d3.select(".Rhino").classed("imghidden",true);
                d3.select(".Elephant").classed("imghidden",true);
                d3.select(".Parrot").classed("imghidden",true);
            });
            
            d3.select(".BElephant").on("click", function(){
                console.log("Elephant");
                
                d3.select(".Elephant").classed("imghidden",false);
                d3.select(".Rhino").classed("imghidden",true);
                d3.select(".Tiger").classed("imghidden",true);
                d3.select(".Parrot").classed("imghidden",true);
            });
            
            d3.select(".BRhino").on("click", function(){
                console.log("Rhino");
                
                d3.select(".Rhino").classed("imghidden",false);
                d3.select(".Tiger").classed("imghidden",true);
                d3.select(".Elephant").classed("imghidden",true);
                d3.select(".Parrot").classed("imghidden",true);
            });
            
            d3.select(".BParrot").on("click", function(){
                console.log("Grey Parrot");
                
                d3.select(".Parrot").classed("imghidden",false);
                d3.select(".Rhino").classed("imghidden",true);
                d3.select(".Elephant").classed("imghidden",true);
                d3.select(".Tiger").classed("imghidden",true);
            });
            
            var format = d3.format(",");

            // Set tooltips
            var tip = d3.tip()
                .attr('class', 'd3-tip')
                .offset([-10, 0])
                .html(function(d) {
                    
                    if (isNaN(d.population)){
                        return "<strong>Country: </strong><span class='details'>" + d.properties.name + "<br></span>"
                    }
                    else{
                        return "<strong>Country: </strong><span class='details'>" + d.properties.name + "<br></span>" + "<strong>Ivory Products: </strong><span class='details'>" + format(Math.floor(d.population)) +"</span>";
                    }      
                });
            
            // Setting tooltip directions for edge cases
            tip.direction(function(d) {
              
                if (d.properties.name === 'Antarctica') return 'n';
                // Americas
                if (d.properties.name === 'Greenland') return 's';
                if (d.properties.name === 'Canada') return 'e';
                if (d.properties.name === 'USA') return 'e';
                if (d.properties.name === 'Mexico') return 'e';
                // Europe
                if (d.properties.name === 'Iceland') return 's';
                if (d.properties.name === 'Norway') return 's';
                if (d.properties.name === 'Sweden') return 's';
                if (d.properties.name === 'Finland') return 's';
                if (d.properties.name === 'Russia') return 'w';
                // Asia
                if (d.properties.name === 'China') return 'w';
                if (d.properties.name === 'Japan') return 's';
                // Oceania
                if (d.properties.name === 'Indonesia') return 'w';
                if (d.properties.name === 'Papua New Guinea') return 'w';
                if (d.properties.name === 'Australia') return 'w';
                if (d.properties.name === 'New Zealand') return 'w';
                // otherwise if not specified
                return 'n';
            });
            
            // Setting tooltip offsets for edge cases
            tip.offset(function(d) { // [top, left]
              if (d.properties.name === 'Antarctica') return [0, 0];
              // Americas
              if (d.properties.name === 'Greenland') return [10, -10];
              if (d.properties.name === 'Canada') return [24, -28];
              if (d.properties.name === 'USA') return [30, 8];
              if (d.properties.name === 'Mexico') return [12, 10];
              if (d.properties.name === 'Chile') return [0, -15];
              // Europe
              if (d.properties.name === 'Iceland') return [15, 0];
              if (d.properties.name === 'Norway') return [10, -28];
              if (d.properties.name === 'Sweden') return [10, -8];
              if (d.properties.name === 'Finland') return [10, 0];
              if (d.properties.name === 'France') return [-9, 66];
              if (d.properties.name === 'Italy') return [-8, -6];
              if (d.properties.name === 'Russia') return [-35, 350];
              // Africa
              if (d.properties.name === 'Madagascar') return [-10, 10];
              // Asia
              if (d.properties.name === 'China') return [-16, -8];
              if (d.properties.name === 'Mongolia') return [-5, 0];
              if (d.properties.name === 'Pakistan') return [-10, 13];
              if (d.properties.name === 'India') return [-11, -18];
              if (d.properties.name === 'Nepal') return [-8, 1];
              if (d.properties.name === 'Myanmar') return [-12, 0];
              if (d.properties.name === 'Laos') return [-12, -8];
              if (d.properties.name === 'Vietnam') return [-12, -4];
              if (d.properties.name === 'Japan') return [5, 5];
              // Oceania
              if (d.properties.name === 'Indonesia') return [0, -5];
              if (d.properties.name === 'Papua New Guinea') return [-5, -10];
              if (d.properties.name === 'Australia') return [-15, 0];
              if (d.properties.name === 'New Zealand') return [-15, 0];
              // otherwise if not specified
              return [-10, 0];
            }) 
            
            // Only defined for projection, not used anywhere else    
            var margin = {top: 0, right: 0, bottom: 0, left: 0},
                width = 960 - margin.left - margin.right,
                height = 500 - margin.top - margin.bottom;
            
            var svg = d3.select(".Map-Container")
                .append('g')
                .attr('class', 'map');
            
            var g = svg.select("g");
            //console.log(svg);

            
            // Manipulating colours
            var colors = d3.scaleThreshold()
                .domain([1,5,182,280,371,507])
                .range(["#fee5d9","#fcbba1","#fc9272","#fb6a4a","#de2d26","#D81E05"]);
            
            function color (d){
                
                if (isNaN(d)==false) {
                    return colors(d);
                }
                else {
                    //return "rgb(247,251,255)"   
                    return "lightgrey";
                }
            }
            
            /*var projection = d3.geoVanDerGrinten()//d3.geoCylindricalStereographic()
                .scale(100)
                .translate([width / 2, height / 2]);*/
            
            var projection = d3.geoKavrayskiy7()//d3.geoCylindricalStereographic()
                .scale(150)
                .translate([width / 2, height / 2]);
            

            /*var projection = d3.geoMercator()//d3.geoCylindricalStereographic()
                .scale(110)
                .translate([width / 2, height / 1.5]);
*/
            var path = d3.geoPath().projection(projection);

            svg.call(tip);
            
            queue()
               .defer(d3.json, "world_map.json")
               .defer(d3.csv, "out_2016.csv")
               .await(ready);
            
            function ready(error, data, population) {
                var populationById = {};

                population.forEach(function(d) { populationById[d.id] = +d.population; });
                data.features.forEach(function(d) { d.population = populationById[d.id] });

                svg.append("g")
                    .attr("class", "countries")
                    .selectAll("path")
                    .data(data.features)
                        .enter().append("path")
                        .attr("d", path)
                        .style("fill", function(d) { 
                            //console.log(populationById[d.id])
                            return color(populationById[d.id]); 
                        })
                        .style('stroke', 'darkgrey')
                        .style('stroke-width', 1.5)
                        .style("opacity",0.8)
                        // tooltips
                        .style("stroke","white")
                        .style('stroke-width', 0.3)
                        .on('mouseover',function(d){
                          tip.show(d);

                          d3.select(this)
                            .style("opacity", 1)
                            .style("stroke","white")
                            .style("stroke-width",2);
                        })
                        .on('mouseout', function(d){
                          tip.hide(d);

                          d3.select(this)
                            .style("opacity", 0.8)
                            .style("stroke","white")
                            .style("stroke-width",0.3);
                        });

                svg.append("path")
                    .datum(topojson.mesh(data.features, function(a, b) { return a.id !== b.id; }))
                    // .datum(topojson.mesh(data.features, function(a, b) { return a !== b; }))
                    .attr("class", "names")
                    .attr("d", path);
                }
            
            
        </script>
        
</body>
</html>